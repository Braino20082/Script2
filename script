-- Server-Script
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- AdminEvents-Ordner erstellen, falls nicht vorhanden
local RemoteFolder = ReplicatedStorage:FindFirstChild("AdminEvents")
if not RemoteFolder then
    RemoteFolder = Instance.new("Folder")
    RemoteFolder.Name = "AdminEvents"
    RemoteFolder.Parent = ReplicatedStorage
end

-- RunAdminEvent erstellen, falls nicht vorhanden
local RunEvent = RemoteFolder:FindFirstChild("RunAdminEvent")
if not RunEvent then
    RunEvent = Instance.new("RemoteEvent")
    RunEvent.Name = "RunAdminEvent"
    RunEvent.Parent = RemoteFolder
end

-- Server-Event-Funktion
RunEvent.OnServerEvent:Connect(function(player, eventName)
    print(player.Name .. " hat Event angefordert: " .. tostring(eventName))

    if eventName == "Heal" then
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.Health = player.Character.Humanoid.MaxHealth
        end
    elseif eventName == "GiveSword" then
        local sword = Instance.new("Tool")
        sword.Name = "Sword"
        sword.RequiresHandle = false
        sword.Parent = player.Backpack
    elseif eventName == "Explosion" then
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local explosion = Instance.new("Explosion")
            explosion.Position = player.Character.HumanoidRootPart.Position
            explosion.BlastRadius = 10
            explosion.Parent = workspace
        end
    else
        local found = nil
        for _, parent in ipairs({ReplicatedStorage, workspace}) do
            local ev = parent:FindFirstChild(eventName, true)
            if ev and ev:IsA("RemoteEvent") then
                found = ev
                break
            end
        end
        if found then
            print("Server ruft RemoteEvent "..eventName.." auf (FireClient simuliert)")
            found:FireClient(player)
        else
            warn("Kein RemoteEvent gefunden: " .. tostring(eventName))
        end
    end
end)

-- Spieler hinzufügen und AdminPanel-Client-Script erstellen
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        -- Überprüfen, ob das Script schon existiert
        if player:FindFirstChild("PlayerGui"):FindFirstChild("AdminPanelClient") then return end

        local guiScript = Instance.new("LocalScript")
        guiScript.Name = "AdminPanelClient"

        guiScript.Source = [[
            local Players = game:GetService("Players")
            local ReplicatedStorage = game:GetService("ReplicatedStorage")
            local player = Players.LocalPlayer

            local RunEvent = ReplicatedStorage:WaitForChild("AdminEvents"):WaitForChild("RunAdminEvent")

            local function getAllRemoteEvents()
                local function gather(parent)
                    local out = {}
                    for _, v in pairs(parent:GetDescendants()) do
                        if v:IsA("RemoteEvent") then
                            table.insert(out, v)
                        end
                    end
                    return out
                end

                local remotes = {}
                for _, p in pairs({ReplicatedStorage, workspace}) do
                    for _, r in pairs(gather(p)) do
                        table.insert(remotes, r)
                    end
                end
                return remotes
            end

            -- GUI erstellen
            local ScreenGui = Instance.new("ScreenGui")
            ScreenGui.Name = "AdminPanelGui"
            ScreenGui.Parent = player:WaitForChild("PlayerGui")

            local MainFrame = Instance.new("Frame")
            MainFrame.Size = UDim2.new(0, 250, 0, 400)
            MainFrame.Position = UDim2.new(0, 20, 0.5, -200)
            MainFrame.BackgroundColor3 = Color3.fromRGB(40,40,40)
            MainFrame.Parent = ScreenGui
            local corner = Instance.new("UICorner", MainFrame)
            corner.CornerRadius = UDim.new(0.05,0)

            local Title = Instance.new("TextLabel")
            Title.Size = UDim2.new(1,0,0,40)
            Title.BackgroundTransparency = 1
            Title.Text = "Admin Panel"
            Title.TextColor3 = Color3.fromRGB(220,220,220)
            Title.Font = Enum.Font.GothamBold
            Title.TextSize = 24
            Title.Parent = MainFrame

            local Scroll = Instance.new("ScrollingFrame")
            Scroll.Size = UDim2.new(1,-10,1,-50)
            Scroll.Position = UDim2.new(0,5,0,45)
            Scroll.BackgroundTransparency = 1
            Scroll.ScrollBarThickness = 6
            Scroll.CanvasSize = UDim2.new(0,0,0,0)
            Scroll.Parent = MainFrame

            local Layout = Instance.new("UIListLayout", Scroll)
            Layout.SortOrder = Enum.SortOrder.LayoutOrder
            Layout.Padding = UDim.new(0,5)
            Layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                Scroll.CanvasSize = UDim2.new(0,0,0, Layout.AbsoluteContentSize.Y + 10)
            end)

            local function createButton(text, action)
                local btn = Instance.new("TextButton")
                btn.Size = UDim2.new(1,-10,0,35)
                btn.BackgroundColor3 = Color3.fromRGB(90,90,90)
                btn.TextColor3 = Color3.fromRGB(220,220,220)
                btn.Font = Enum.Font.Gotham
                btn.TextScaled = true
                btn.Text = text
                btn.Parent = Scroll
                local bcorner = Instance.new("UICorner", btn)
                bcorner.CornerRadius = UDim.new(0.1,0)
                btn.MouseButton1Click:Connect(function()
                    RunEvent:FireServer(action)
                end)
            end

            -- Buttons erstellen
            local remotes = getAllRemoteEvents()
            for _, r in ipairs(remotes) do
                createButton("RemoteEvent: "..r.Name, r.Name)
            end

            -- Standard-Admin-Events
            local standardEvents = {"Heal", "GiveSword", "Explosion"}
            for _, e in ipairs(standardEvents) do
                createButton(e, e)
            end
        ]]

        guiScript.Parent = player:WaitForChild("PlayerGui")
    end)
end)
